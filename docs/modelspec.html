<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Model Selection &amp; Fitting | RESTful Scraping API for Real Estate data, a Spatial Bayesian modeling perspective with INLA</title>
  <meta name="description" content="This is Niccolò Salvini master’s thesis project" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Model Selection &amp; Fitting | RESTful Scraping API for Real Estate data, a Spatial Bayesian modeling perspective with INLA" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://niccolosalvini.github.io/Thesis/" />
  <meta property="og:image" content="https://niccolosalvini.github.io/Thesis/images/logo/spatial_logo.png" />
  <meta property="og:description" content="This is Niccolò Salvini master’s thesis project" />
  <meta name="github-repo" content="NiccoloSalvini/thesis" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Model Selection &amp; Fitting | RESTful Scraping API for Real Estate data, a Spatial Bayesian modeling perspective with INLA" />
  
  <meta name="twitter:description" content="This is Niccolò Salvini master’s thesis project" />
  <meta name="twitter:image" content="https://niccolosalvini.github.io/Thesis/images/logo/spatial_logo.png" />

<meta name="author" content="Niccolò Salvini" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="images/logo/spatial_logo.png" />
  <link rel="shortcut icon" href="images/logo/spatial_logo.ico" type="image/x-icon" />
<link rel="prev" href="exploratory.html"/>
<link rel="next" href="conclusions.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-171723874-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-171723874-1');
</script>



<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo"><a href="./"><img src="images/logo/spatial_logo.png"></a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preliminary Content</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#abstract"><i class="fa fa-check"></i>Abstract</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#dedication"><i class="fa fa-check"></i>Dedication</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="scraping.html"><a href="scraping.html"><i class="fa fa-check"></i><b>2</b> Web Scraping</a><ul>
<li class="chapter" data-level="2.1" data-path="scraping.html"><a href="scraping.html#reverse"><i class="fa fa-check"></i><b>2.1</b> A Gentle Introduction on Web Scraping</a></li>
<li class="chapter" data-level="2.2" data-path="scraping.html"><a href="scraping.html#anatomy-of-a-url-and-reverse-engineering"><i class="fa fa-check"></i><b>2.2</b> Anatomy of a url and reverse engineering</a><ul>
<li class="chapter" data-level="2.2.1" data-path="scraping.html"><a href="scraping.html#scraping-with-rvest"><i class="fa fa-check"></i><b>2.2.1</b> Scraping with <code id="ContentArchitecture">rvest</code></a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="scraping.html"><a href="scraping.html#ProperScraping"><i class="fa fa-check"></i><b>2.3</b> Searching Technique for Scarping</a></li>
<li class="chapter" data-level="2.4" data-path="scraping.html"><a href="scraping.html#best-practices"><i class="fa fa-check"></i><b>2.4</b> Scraping Best Practices and Security provisions</a></li>
<li class="chapter" data-level="2.5" data-path="scraping.html"><a href="scraping.html#HTTPmethod"><i class="fa fa-check"></i><b>2.5</b> HTTP overview</a><ul>
<li class="chapter" data-level="2.5.1" data-path="scraping.html"><a href="scraping.html#spoofing"><i class="fa fa-check"></i><b>2.5.1</b> User Agent and further Identification Headers Spoofing</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="scraping.html"><a href="scraping.html#possibly"><i class="fa fa-check"></i><b>2.6</b> Dealing with failure</a></li>
<li class="chapter" data-level="2.7" data-path="scraping.html"><a href="scraping.html#parallelscraping"><i class="fa fa-check"></i><b>2.7</b> Parallel Scraping</a><ul>
<li class="chapter" data-level="2.7.1" data-path="scraping.html"><a href="scraping.html#parallel-furrrfuture"><i class="fa fa-check"></i><b>2.7.1</b> Parallel furrr+future</a></li>
<li class="chapter" data-level="2.7.2" data-path="scraping.html"><a href="scraping.html#parallel-foreachdofuture"><i class="fa fa-check"></i><b>2.7.2</b> Parallel foreach+doFuture</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="scraping.html"><a href="scraping.html#legal"><i class="fa fa-check"></i><b>2.8</b> Legal Profiles</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="Infrastructure.html"><a href="Infrastructure.html"><i class="fa fa-check"></i><b>3</b> API Technology Stack</a><ul>
<li class="chapter" data-level="3.1" data-path="Infrastructure.html"><a href="Infrastructure.html#restful-api"><i class="fa fa-check"></i><b>3.1</b> RESTful API</a><ul>
<li class="chapter" data-level="3.1.1" data-path="Infrastructure.html"><a href="Infrastructure.html#plumberapi"><i class="fa fa-check"></i><b>3.1.1</b> Plumber HTTP API</a></li>
<li class="chapter" data-level="3.1.2" data-path="Infrastructure.html"><a href="Infrastructure.html#sanitize"><i class="fa fa-check"></i><b>3.1.2</b> Sanitization</a></li>
<li class="chapter" data-level="3.1.3" data-path="Infrastructure.html"><a href="Infrastructure.html#DoS"><i class="fa fa-check"></i><b>3.1.3</b> Denial Of Service (DoS)</a></li>
<li class="chapter" data-level="3.1.4" data-path="Infrastructure.html"><a href="Infrastructure.html#logging"><i class="fa fa-check"></i><b>3.1.4</b> Logging</a></li>
<li class="chapter" data-level="3.1.5" data-path="Infrastructure.html"><a href="Infrastructure.html#docs"><i class="fa fa-check"></i><b>3.1.5</b> RESTful API docs</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="Infrastructure.html"><a href="Infrastructure.html#docker"><i class="fa fa-check"></i><b>3.2</b> Docker</a><ul>
<li class="chapter" data-level="3.2.1" data-path="Infrastructure.html"><a href="Infrastructure.html#dockerfile"><i class="fa fa-check"></i><b>3.2.1</b> REST-API container</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="Infrastructure.html"><a href="Infrastructure.html#nginx"><i class="fa fa-check"></i><b>3.3</b> NGINX reverse Proxy Server and Authorization</a></li>
<li class="chapter" data-level="3.4" data-path="Infrastructure.html"><a href="Infrastructure.html#docker-compose"><i class="fa fa-check"></i><b>3.4</b> Docker-Compose</a></li>
<li class="chapter" data-level="3.5" data-path="Infrastructure.html"><a href="Infrastructure.html#HTTPS"><i class="fa fa-check"></i><b>3.5</b> HTTPS(ecure) and SSL certificates</a></li>
<li class="chapter" data-level="3.6" data-path="Infrastructure.html"><a href="Infrastructure.html#aws"><i class="fa fa-check"></i><b>3.6</b> AWS EC2 instance</a></li>
<li class="chapter" data-level="3.7" data-path="Infrastructure.html"><a href="Infrastructure.html#sdwf"><i class="fa fa-check"></i><b>3.7</b> Software CI/CD Workflow</a></li>
<li class="chapter" data-level="3.8" data-path="Infrastructure.html"><a href="Infrastructure.html#further-sf-integrations"><i class="fa fa-check"></i><b>3.8</b> Further SF Integrations</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="inla.html"><a href="inla.html"><i class="fa fa-check"></i><b>4</b> INLA</a><ul>
<li class="chapter" data-level="4.1" data-path="inla.html"><a href="inla.html#LGM"><i class="fa fa-check"></i><b>4.1</b> The class of Latent Gaussian Models (LGM)</a></li>
<li class="chapter" data-level="4.2" data-path="inla.html"><a href="inla.html#gmrf"><i class="fa fa-check"></i><b>4.2</b> Gaussian Markov Random Field (GMRF)</a></li>
<li class="chapter" data-level="4.3" data-path="inla.html"><a href="inla.html#approx"><i class="fa fa-check"></i><b>4.3</b> INLA Laplace Approximations</a></li>
<li class="chapter" data-level="4.4" data-path="inla.html"><a href="inla.html#rinla"><i class="fa fa-check"></i><b>4.4</b> R-INLA package</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="prdm.html"><a href="prdm.html"><i class="fa fa-check"></i><b>5</b> Geostatistical Data analysis</a><ul>
<li class="chapter" data-level="5.1" data-path="prdm.html"><a href="prdm.html#GP"><i class="fa fa-check"></i><b>5.1</b> Gaussian Process (GP)</a></li>
<li class="chapter" data-level="5.2" data-path="prdm.html"><a href="prdm.html#spdeapproach"><i class="fa fa-check"></i><b>5.2</b> The Stochastic Partial Differential Equation (SPDE) approach</a></li>
<li class="chapter" data-level="5.3" data-path="prdm.html"><a href="prdm.html#hedonic-rental-price-models"><i class="fa fa-check"></i><b>5.3</b> Hedonic (rental) Price Models</a></li>
<li class="chapter" data-level="5.4" data-path="prdm.html"><a href="prdm.html#criticism"><i class="fa fa-check"></i><b>5.4</b> Model Criticism</a><ul>
<li class="chapter" data-level="5.4.1" data-path="prdm.html"><a href="prdm.html#predbase"><i class="fa fa-check"></i><b>5.4.1</b> Methods based on the predictive distribution</a></li>
<li class="chapter" data-level="5.4.2" data-path="prdm.html"><a href="prdm.html#deviance-based-criteria"><i class="fa fa-check"></i><b>5.4.2</b> Deviance-based Criteria</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="prdm.html"><a href="prdm.html#priorsspec"><i class="fa fa-check"></i><b>5.5</b> Penalized Complexity Priors</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="exploratory.html"><a href="exploratory.html"><i class="fa fa-check"></i><b>6</b> Exploratory Analysis</a><ul>
<li class="chapter" data-level="6.1" data-path="exploratory.html"><a href="exploratory.html#prep"><i class="fa fa-check"></i><b>6.1</b> Preprocessing and Feature Engineering</a></li>
<li class="chapter" data-level="6.2" data-path="exploratory.html"><a href="exploratory.html#spatassess"><i class="fa fa-check"></i><b>6.2</b> Spatial Dependece Assessement</a></li>
<li class="chapter" data-level="6.3" data-path="exploratory.html"><a href="exploratory.html#factor-counts"><i class="fa fa-check"></i><b>6.3</b> Factor Counts</a></li>
<li class="chapter" data-level="6.4" data-path="exploratory.html"><a href="exploratory.html#assessing-the-most-valuable-properties"><i class="fa fa-check"></i><b>6.4</b> Assessing the most valuable properties</a></li>
<li class="chapter" data-level="6.5" data-path="exploratory.html"><a href="exploratory.html#assessing-relevant-predictors"><i class="fa fa-check"></i><b>6.5</b> Assessing relevant predictors</a></li>
<li class="chapter" data-level="6.6" data-path="exploratory.html"><a href="exploratory.html#missassimp"><i class="fa fa-check"></i><b>6.6</b> Missing Assessement and Imputation</a><ul>
<li class="chapter" data-level="6.6.1" data-path="exploratory.html"><a href="exploratory.html#missing-assessement"><i class="fa fa-check"></i><b>6.6.1</b> Missing assessement</a></li>
<li class="chapter" data-level="6.6.2" data-path="exploratory.html"><a href="exploratory.html#missing-imputation"><i class="fa fa-check"></i><b>6.6.2</b> Missing Imputation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="modelspec.html"><a href="modelspec.html"><i class="fa fa-check"></i><b>7</b> Model Selection &amp; Fitting</a><ul>
<li class="chapter" data-level="7.1" data-path="modelspec.html"><a href="modelspec.html#modelspecandmesh"><i class="fa fa-check"></i><b>7.1</b> Model Specification &amp; Mesh Assessement</a></li>
<li class="chapter" data-level="7.2" data-path="modelspec.html"><a href="modelspec.html#spdemodeol"><i class="fa fa-check"></i><b>7.2</b> Building the SPDE object</a></li>
<li class="chapter" data-level="7.3" data-path="modelspec.html"><a href="modelspec.html#model-selection"><i class="fa fa-check"></i><b>7.3</b> Model selection</a></li>
<li class="chapter" data-level="7.4" data-path="modelspec.html"><a href="modelspec.html#fit"><i class="fa fa-check"></i><b>7.4</b> Parameter estimation and Results</a></li>
<li class="chapter" data-level="7.5" data-path="modelspec.html"><a href="modelspec.html#spatial-model-criticism"><i class="fa fa-check"></i><b>7.5</b> Spatial Model Criticism</a></li>
<li class="chapter" data-level="7.6" data-path="modelspec.html"><a href="modelspec.html#spatial-prediction-on-grid"><i class="fa fa-check"></i><b>7.6</b> Spatial Prediction on grid</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conclusions.html"><a href="conclusions.html"><i class="fa fa-check"></i><b>8</b> Conclusions</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i>Appendix</a><ul>
<li class="chapter" data-level="8.1" data-path="appendix.html"><a href="appendix.html#triangular"><i class="fa fa-check"></i><b>8.1</b> SPDE and Triangulation</a></li>
<li class="chapter" data-level="8.2" data-path="appendix.html"><a href="appendix.html#laplaceapprox"><i class="fa fa-check"></i><b>8.2</b> Laplace Approximation</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/NiccoloSalvini/tesi-prova" target="blank"> See Github Repository</a></li>
<li><a href="https://niccolosalvini.netlify.app/">About The Author</a></li>
<li><a Proudly published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">RESTful Scraping API for Real Estate data, a Spatial Bayesian modeling perspective with INLA</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="modelspec" class="section level1">
<h1><span class="header-section-number">Chapter 7</span> Model Selection &amp; Fitting</h1>
<p>In this chapter it is applied all the theory seen so far through the lenses of R-INLA package on the scraped data. The hierarchical Latent Gaussian model to-be-fitted sets against the response price with the other predictors scraped. As a consequence on top of the hierarchy i.e. the higher level the model places the likelihood of data for which a Normal distribution is specified. At the medium level the GMRF containing the latent components and distributed as a Multivariate Normal (centered in zero and with “markov” properties encoded in the precision matrix). In the end priors are specified both for measurement error precision and for the latent field (penalized in complexity) i.e. the variance of the spatial process and the Matérn hyper parameters. The SPDE approach trinagularize the spatial domain and makes possible to pass from a discrete surface to a continuous representation of the own process. This requires a series of steps ranging from mesh building, passing the mesh inside the Matérn obtaining the spde object and then reprojecting through the stack function. In the end the model is fitted integrating the spatial random field. Posterior distributions for parameters and hyper parameters are then evaluated and summarized.</p>
<p>In order to make the distribution of the response i.e. price (per month in €) approximately Normal it is applied a <span class="math inline">\(log_{10}\)</span> transformation (further transformation would have better Normalized data i.e. Box-Cox <span class="citation">(Box and Cox <a href="#ref-boxcox" role="doc-biblioref">1964</a>)</span> and Yeo-Johnson <span class="citation">(Yeo and Johnson <a href="#ref-yeojohnson" role="doc-biblioref">2000</a>)</span> however they over complicate interpretability). Moreover all of the numerical covariates e.g. <em>condominium</em>, <em>sqmeter</em> and <em>photosnum</em> have already been prepared in <a href="exploratory.html#prep">6.1</a> and are further standardized and scaled. The Locations are represented in map plot <a href="modelspec.html#fig:ggmap">7.1</a> within the borders of the Municipality of Milan. At first the borders shapefile is imported from <a href="https://geoportale.comune.milano.it/sit/open-data/">GeoPortale Milano</a>. The corresponding CRS is in UTM (i.e. Eastings and Northings) which differs from the spatial covariates extracted (lat and long). Therefore the spatial entity needs to be rescaled and reprojected to the new CRS. In the end the latitude and the longitude points are overlayed to the borders as in figure <a href="modelspec.html#fig:ggmap">7.1</a>.</p>
<div class="figure"><span id="fig:ggmap"></span>
<img src="07-model_fitting_files/figure-html/ggmap-1.png" alt="Milan Real Estate data within the Municpality borders, 4 points of interest" width="672" />
<p class="caption">
Figure 7.1: Milan Real Estate data within the Municpality borders, 4 points of interest
</p>
</div>
<div id="modelspecandmesh" class="section level2">
<h2><span class="header-section-number">7.1</span> Model Specification &amp; Mesh Assessement</h2>
<p>WIth the aim to harness INLA power a hierarchical LGM need to be imposed. Its definition starts from fitting an exponential family distribution on Milan Real Estate Rental data <span class="math inline">\(\mathbf{y}\)</span> i.e. normal distribution:</p>
<p><span class="math display">\[
\mathbf{y}\sim \operatorname{Normal}\left(\boldsymbol\mu, \sigma_{e}^{2}\right)
\]</span></p>
<p>Then the linear predictor i.e. the mean, since the function <span class="math inline">\(\mathrm{g}\left(\boldsymbol\mu\right)\)</span> is identity, is:</p>
<p><span class="math display">\[
\boldsymbol\eta=b_{0}+\boldsymbol x \boldsymbol\beta+\boldsymbol\xi 
\]</span>
where, following the notation in expression <a href="#eq:linearpredictor">(<strong>??</strong>)</a>, <span class="math inline">\(\boldsymbol\xi\)</span> is the spatial random effect assigned to the function <span class="math inline">\(f_1()\)</span>, for the set of coviarates <span class="math inline">\(\boldsymbol{z}=\left(x_{1} = lat,\, x_{2} = long\right)\)</span>. <span class="math inline">\(\boldsymbol\xi\)</span> is also the GMRF defined in<a href="#def:gmrf"><strong>??</strong></a>, as a result it is distributed as a multivariate Normal centered in 0 and whose covariance function is Matérn (fig. <a href="#fig:matern"><strong>??</strong></a>) i.e. <span class="math inline">\(\xi_{i} \sim N\left(\mathbf{0}, \mathbf{Q}_{\mathscr{C}}^{-1}\right)\)</span>. The precision matrix <span class="math inline">\(\mathbf{Q}_{\mathscr{C}}^{-1}\)</span> (see left panel in figure <a href="#fig:precisionmat"><strong>??</strong></a>) is the one that requires to be treated with SPDE and its dimensions are <span class="math inline">\(n \times n\)</span>, in this case when NAs are omitted and after imputation it results in <span class="math inline">\(192 \times 192\)</span>.
<span class="math inline">\(\boldsymbol\beta\)</span> are the model scraped covariates coefficients, which include condom, totlocali, altro, bagno, cucina, heating … and the rest.
Then the latent field is composed by <span class="math inline">\(\boldsymbol{\theta}=\{\boldsymbol{\xi}, \boldsymbol{\beta}\}\)</span>. In the end following the traits of the final expression in <a href="prdm.html#GP">5.1</a> the LGM can be reformatted as follows,</p>
<p><span class="math display">\[
\boldsymbol{\mathbf{y}}=\boldsymbol{z} \boldsymbol{\beta}+\boldsymbol{\xi}+\boldsymbol{\varepsilon}, \quad \boldsymbol{\varepsilon} \sim N\left(\mathbf{0},  \sigma^2_{\varepsilon} I_{d}\right)
\]</span>
Priors are assigned as Gaussian vagues ones for the <span class="math inline">\(\boldsymbol\beta\)</span> coefficients with fixed precision, indeed for the GMRF priors are assigned to the matérn process <span class="math inline">\(\tilde{\boldsymbol\xi}\)</span> as Penalized in Complexity.
Thus following the steps and notation marked in sec. <a href="inla.html#LGM">4.1</a>. the <em>higher</em> level eq. <a href="#eq:higher">(<strong>??</strong>)</a> is constituted by the <strong>likelihood</strong>, depending on hyper parameters <span class="math inline">\(\boldsymbol\psi_1 = \left(\sigma_{\mathscr{\xi}}^{2}, \phi, \nu\right)\)</span>:</p>
<p><span class="math display">\[\pi(\boldsymbol{\mathbf{y}} \mid \boldsymbol{\theta}, \boldsymbol{\psi_1})=\prod_{i\ = 1}^{\mathbf{192}} \pi\left(y_{i} \mid \theta_{i}, \boldsymbol{\psi_1}\right)\]</span></p>
<p>At the <em>medium</em> level eq. <a href="#eq:medium">(<strong>??</strong>)</a> there exists the <strong>latent field</strong> <span class="math inline">\(\pi(\boldsymbol{\theta} \mid \boldsymbol\psi_2)\)</span>, conditioned to the hyper parameter <span class="math inline">\(\boldsymbol\psi_2 = \{\sigma_{\varepsilon}^2\}\)</span>, whose only component is the measurement error precision,</p>
<p><span class="math display">\[  \pi(\boldsymbol{\theta} \mid \boldsymbol{\psi_2})=(2 \pi)^{-n / 2}| \boldsymbol{Q_{\mathscr{C}}(\psi_2)}|^{1 / 2} \exp \left(-\frac{1}{2} \boldsymbol{\theta}^{\prime} \boldsymbol{Q_{\mathscr{C}}(\psi_2)} \boldsymbol{\theta}\right)\]</span></p>
<p>In the lower level priors are considered as their joint distribution i.e. <span class="math inline">\(\boldsymbol\psi_ =\{ \boldsymbol\psi_1\, \boldsymbol\psi_2\}\)</span>. It follows the expression of the joint posterior distribution:</p>
<p><span class="math display">\[
\pi(\boldsymbol{\theta}, \boldsymbol{\psi} \mid \mathbf{y})\propto  \underbrace{\pi(\boldsymbol{\psi})}_{\text {priors}} \times \underbrace{\pi(\boldsymbol\theta \mid \boldsymbol\psi)}_{\text {GMRF}} \times \underbrace{\prod_{i=1}^{\mathbf{192}} \pi\left(\mathbf{y} \mid \boldsymbol\theta, \boldsymbol{\psi}\right)}_{\text {likelihood }}
\]</span>
Then once again the objectives of bayesian inference are the posterior marginal distributions for the latent field and the hyperparameters, which are contained in equation <a href="#eq:finalobj">(<strong>??</strong>)</a>, for which Laplace approximations in <a href="inla.html#approx">4.3</a> are employed.</p>
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
<!-- paramtere estimation and spatial prediction -->
</div>
<div id="spdemodeol" class="section level2">
<h2><span class="header-section-number">7.2</span> Building the SPDE object</h2>
<p>SPDE requires to triangulate the domain space <span class="math inline">\(\mathscr{D}\)</span> as intuited in <a href="prdm.html#spdeapproach">5.2</a>. The function <code>inla.mesh.2d</code> together with the <code>inla.nonconvex.hull</code> are able to define a good triangulation since no proper boundaries are provided. Four meshes are produced, whose figures are in <a href="modelspec.html#fig:meshes">7.2</a>. Triangles appears to be thoroughly smooth and equilateral. The extra offset prevents the model to be affected by boundary effects. However the maximum accessible number of vertices is in <span class="math inline">\(\operatorname{mesh}_3\)</span> , it seems to have the most potential for this dataset. Critical parameters for meshes are <code>max.edge=c(0.01, 0.02)</code> and <code>offset=c(0.0475, 0.0625))</code> which in fact mold their sophistication. Further trials have shown that below the lower bound of max.edge of <span class="math inline">\(0.01\)</span> the function is not able to produce the triangulation.</p>
<div class="figure"><span id="fig:meshes"></span>
<img src="07-model_fitting_files/figure-html/meshes-1.png" alt="Left: mesh traingulation for 156 vertices, Right: mesh traingulation for 324 vertices" width="672" />
<p class="caption">
Figure 7.2: Left: mesh traingulation for 156 vertices, Right: mesh traingulation for 324 vertices
</p>
</div>
<p>The SPDE model object is built with the function <code>inla.spde2.pcmatern()</code> which needs as arguments the mesh triangulation, i.e. <span class="math inline">\(\operatorname{mesh}_3\)</span> and the PC priors <a href="prdm.html#priorsspec">5.5</a>, satisfying the following probability statements: <span class="math inline">\(\operatorname{Prob}(\sigma_{\varepsilon}^2&lt;3060)&lt; 0.01\)</span> where <span class="math inline">\(\sigma_{\varepsilon}^2\)</span> is the spatial range desumed in <a href="#fig:semivariogram"><strong>??</strong></a>. And <span class="math inline">\(\operatorname{Prob}(\tau&gt; 0.9)&lt; 0.05\)</span> where <span class="math inline">\(\tau\)</span> is the marginal standard deviation (on the log scale) of the field <a href="exploratory.html#spatassess">6.2</a>.
As model complexity increases, for instance, a lot of random effects may be discovered in the linear predictor and chances are that SPDE object may get into trouble. As a result the <code>inla.stack</code> function recreates the linear predictor as a combination of the elements of the old linear predictor and the matrix of observations. Further mathematical details about the stack are in <span class="citation">Blangiardo (<a href="#ref-Blangiardo-Cameletti" role="doc-biblioref">2015</a>)</span>, but are beyond the scope of the analysis.</p>
</div>
<div id="model-selection" class="section level2">
<h2><span class="header-section-number">7.3</span> Model selection</h2>
<p>Since covariates are many they arouse also many possible combinations of predictors that may better shape complex dynamics. However, there is the possibility to take advantage of several natively implemented ways to use built-in features. As a matter of fact in section <a href="#devbased"><strong>??</strong></a> are presented a set of tools to compare models based on deviance criteria. One of them is DIC which actually balances the number of features applying a penalty when the number of features introduced increases eq. <a href="#eq:dic">(<strong>??</strong>)</a>.
Consequently a Forward Selection <span class="citation">(Guyon and Elisseeff <a href="#ref-guyon2003introduction" role="doc-biblioref">2003</a>)</span> algorithm is designed within the inla function call. One at a time predictors are introduced into the model then results are stored into a dataframe. In the end the most satisfying combination based on DIC is sorted out.</p>
</div>
<div id="fit" class="section level2">
<h2><span class="header-section-number">7.4</span> Parameter estimation and Results</h2>
<p>In the end the model is fitted calling inla on the final formula i.e. <span class="math inline">\(\log_{10}(price) \sim Intercept + totlocali ... \dots + f(coordinate, model = spde1)\)</span> where all the rest of the covariates are omitted for brevity reasons. When the model has run, the conclusions for the random effects will now be discussed.</p>
<table>
<thead>
<tr class="header">
<th align="left">coefficients</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">0.025quant</th>
<th align="right">0.5quant</th>
<th align="right">0.975quant</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Intercept</td>
<td align="right">6.19</td>
<td align="right">12.91</td>
<td align="right">-19.16</td>
<td align="right">6.19</td>
<td align="right">31.51</td>
</tr>
<tr class="even">
<td align="left">totlocali5+</td>
<td align="right">1.92</td>
<td align="right">12.91</td>
<td align="right">-23.43</td>
<td align="right">1.92</td>
<td align="right">27.24</td>
</tr>
<tr class="odd">
<td align="left">totlocaliPentalocale</td>
<td align="right">1.55</td>
<td align="right">12.91</td>
<td align="right">-23.80</td>
<td align="right">1.55</td>
<td align="right">26.88</td>
</tr>
<tr class="even">
<td align="left">totlocaliQuadrilocale</td>
<td align="right">1.20</td>
<td align="right">12.91</td>
<td align="right">-24.14</td>
<td align="right">1.20</td>
<td align="right">26.53</td>
</tr>
<tr class="odd">
<td align="left">totlocaliTrilocale</td>
<td align="right">0.93</td>
<td align="right">12.91</td>
<td align="right">-24.41</td>
<td align="right">0.93</td>
<td align="right">26.26</td>
</tr>
<tr class="even">
<td align="left">totlocaliBilocale</td>
<td align="right">0.58</td>
<td align="right">12.91</td>
<td align="right">-24.76</td>
<td align="right">0.58</td>
<td align="right">25.91</td>
</tr>
<tr class="odd">
<td align="left">totlocaliMonolocale</td>
<td align="right">0.00</td>
<td align="right">31.62</td>
<td align="right">-62.09</td>
<td align="right">0.00</td>
<td align="right">62.03</td>
</tr>
<tr class="even">
<td align="left">condom</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
</tr>
</tbody>
</table>
<p>Since the models coefficients are too many the analysis will concentrate on the most interesting ones. Looking at TAB(…) arranged by descending mean, the posterior mean for the intercept in the rescaled from log is actually quite elevated, affirming that the average house price 485.99 €. Unsurprisingly the covariate condominium is positively correlated with the response price but its effect is not very tangible. This might imply that pricier apartments expect in mean the same condominium cost as the cheaper ones. (qualcosa di più)
Moreover Inla is able to output the mean and the standard deviation of measurement precision error in <span class="math inline">\(\psi_2\)</span> i.e. <span class="math inline">\(1 / \sigma_{\varepsilon}^{2}\)</span>, note that the interpretation is different from variance, see TAB().
<!-- With a combination of `inla.tmarginal()` and  `inla.emarginal()`, refer to \@ref(rinla), it is possible to compute the mean and the sd for the error, see TAB (...) below.  --></p>
<pre><code>##                                              mean        sd 0.025quant
## Precision for the Gaussian observations 14.146477 1.8323868  10.835628
## Theta1 for site                         -4.244211 0.4302051  -5.053108
## Theta2 for site                          4.336038 0.4941173   3.324577
##                                          0.5quant 0.975quant      mode
## Precision for the Gaussian observations 14.049535  18.035766 13.878183
## Theta1 for site                         -4.259375  -3.363177 -4.313992
## Theta2 for site                          4.355101   5.262670  4.422629</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">hyper-param</th>
<th align="right">sd</th>
<th align="right">mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision for the Gaussian observations</td>
<td align="right">1.8323868</td>
<td align="right">13.878183</td>
</tr>
<tr class="even">
<td align="left">Theta1 for site</td>
<td align="right">0.4302051</td>
<td align="right">-4.313992</td>
</tr>
<tr class="odd">
<td align="left">Theta2 for site</td>
<td align="right">0.4941173</td>
<td align="right">4.422629</td>
</tr>
</tbody>
</table>
<p>In respect to the function parameter the Matérn hyper parameters <span class="math inline">\(\psi_1\)</span> (penalized complexity priors) …</p>
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<!-- PLOT THE LATENT FIELD -->
<p>It might be of interest to plot the latent field which is projected from the model.</p>
<div class="figure"><span id="fig:pltgmrf"></span>
<img src="07-model_fitting_files/figure-html/pltgmrf-1.png" alt="Gaussian Markov Random field result from the model" width="672" />
<p class="caption">
Figure 7.3: Gaussian Markov Random field result from the model
</p>
</div>
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
<!-- a further trial  -->
</div>
<div id="spatial-model-criticism" class="section level2">
<h2><span class="header-section-number">7.5</span> Spatial Model Criticism</h2>
<p>The model on the basis of the PIT <a href="prdm.html#predbase">5.4.1</a> the model seems to be able to capture the variability and does not show any residual trend nor failures i.e. $ = $ 0 . The fact that the distribution is seemingly Uniform tells that the model is correctly specified. This is summarized by the LPML statistics which accounts for the negative log sum of each cross validate CPO obtaining 44.573.</p>
<div class="figure"><span id="fig:modelcpo"></span>
<img src="07-model_fitting_files/figure-html/modelcpo-1.png" alt="PIT cross validation statistics on $model_spde1$" width="672" />
<p class="caption">
Figure 7.4: PIT cross validation statistics on <span class="math inline">\(model_spde1\)</span>
</p>
</div>
<pre><code>## [1] 189.4186</code></pre>
</div>
<div id="spatial-prediction-on-grid" class="section level2">
<h2><span class="header-section-number">7.6</span> Spatial Prediction on grid</h2>
<p>A gridded object is required in order to project spatial prediction on the domain space. Usually these operations are very computationally expensive since grid objects size can easily reach <span class="math inline">\(10^4\)</span> to <span class="math inline">\(10^6\)</span> dimension points. Since in this case the linear predictor marginal distributions are not the focus then a more feasible solution consists in projecting the latent field estimated at the triangulation vertices onto the grid location <span class="citation">(<a href="#ref-Blangiardo-Cameletti" role="doc-biblioref">2015</a>)</span>. At first a proper projection matrix is created without specifying the locations.</p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-Blangiardo-Cameletti">
<p>Blangiardo, Michela, Marta; Cameletti. 2015. <em>Spatial and Spatio-Temporal Bayesian Models with R-Inla</em>. Wiley.</p>
</div>
<div id="ref-boxcox">
<p>Box, G. E. P., and D. R. Cox. 1964. “An Analysis of Transformations.” <em>Journal of the Royal Statistical Society. Series B (Methodological)</em> 26 (2): 211–52. <a href="http://www.jstor.org/stable/2984418">http://www.jstor.org/stable/2984418</a>.</p>
</div>
<div id="ref-guyon2003introduction">
<p>Guyon, Isabelle, and André Elisseeff. 2003. “An Introduction to Variable and Feature Selection.” <em>Journal of Machine Learning Research</em> 3 (Mar): 1157–82.</p>
</div>
<div id="ref-yeojohnson">
<p>Yeo, In-Kwon, and Richard Johnson. 2000. “A New Family of Power Transformations to Improve Normality or Symmetry.” <em>Biometrika</em> 87 (December). <a href="https://doi.org/10.1093/biomet/87.4.954">https://doi.org/10.1093/biomet/87.4.954</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="exploratory.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="conclusions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"all": false,
"google": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/NiccoloSalvini/thesis/edit/master/07-model_fitting.Rmd",
"text": "Suggest an edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Niccolo_Salvini_Thesis.pdf"],
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"search": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
